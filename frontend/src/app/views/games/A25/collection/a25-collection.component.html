@if (!error) {
    <h1>Collection</h1>
    <ng-template #forms>
        <form [formGroup]="pageForm" class="form-horizontal">
            @if (openTab === 0) {
                <div class="row" style="margin-top:0.8rem;">
                    <mat-form-field class="col-md-4" appearance="outline">
                      <mat-label>Filter...</mat-label>
                      <input style="height: 100%;" matInput formControlName="filtertext">
                      <mat-icon matSuffix fontSet="atelier atelier-sm" fontIcon="atelier-ryza2-book">&nbsp;</mat-icon>
                    </mat-form-field>
                    <mat-form-field class="col-md-4" appearance="outline">
                      <mat-label>Role</mat-label>
                      <mat-select matNativeControl formControlName="roles" disableOptionCentering="true" class="mat-select-icon">
                        <mat-option value="any" selected>
                          Any
                        </mat-option>
                        @if (data) {
                          @for (role of data.roles; track role) {
                            <mat-option [value]="role.slug">
                              {{role.name}}
                            </mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field class="col-md-4" appearance="outline">
                      <mat-label>Element</mat-label>
                      <mat-select matNativeControl formControlName="elems" disableOptionCentering="true" class="mat-select-icon">
                        <mat-option value="any" selected>
                          Any
                        </mat-option>
                        @if (data) {
                          @for (elem of data.elems; track elem) {
                            <mat-option [value]="elem.slug">
                              {{elem.name}}
                            </mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>
                  <div class="row">
                    <div class="col-md-4" style="display:flex;padding-bottom:1rem;">
                      <button [matMenuTriggerFor]="menuLeft" style="width:2rem;background:none;border:none;padding-right:0.1rem;">
                        <svg viewBox="0 0 125 250" style="max-width:2rem;">
                          <path [attr.fill]="changeFill(pageForm.get('colorL').value)" d="M128.315904 232.287744H122.368L24.448 134.368256V122.399744L122.368 24.479744H128.34304L128.34304 6.144H121.31328L6.11328 121.344V135.424L121.31328 250.624H128.3072zM128.335872 227.199488H124.000256L29.536256 132.735488V124.031488L124.000256 29.567488H128.326656z" />
                        </svg>
                      </button>
                      <button [matMenuTriggerFor]="menuRight" style="width:2rem;background:none;border:none;padding-left:0.1rem;">
                        <svg viewBox="0 0 125 250" style="max-width:2rem;transform:scale(-1,1)">
                          <path [attr.fill]="changeFill(pageForm.get('colorR').value)" d="M128.315904 232.287744H122.368L24.448 134.368256V122.399744L122.368 24.479744H128.34304L128.34304 6.144H121.31328L6.11328 121.344V135.424L121.31328 250.624H128.3072zM128.335872 227.199488H124.000256L29.536256 132.735488V124.031488L124.000256 29.567488H128.326656z" />
                        </svg>
                      </button>
                      <mat-menu #menuLeft="matMenu">
                        <button mat-menu-item (click)="pageForm.controls['colorL'].setValue('any')">
                          Any
                        </button>
                        @if (data) {
                          @for (color of data.colors; track color) {
                            <button mat-menu-item (click)="pageForm.controls['colorL'].setValue(color.slug)">
                              {{color.name}}
                            </button>
                          }
                        }
                      </mat-menu>
                      <mat-menu #menuRight="matMenu">
                        <button mat-menu-item (click)="pageForm.controls['colorR'].setValue('any')">
                          Any
                        </button>
                        @if (data) {
                          @for (color of data.colors; track color) {
                            <button mat-menu-item (click)="pageForm.controls['colorR'].setValue(color.slug)">
                              {{color.name}}
                            </button>
                          }
                        }
                      </mat-menu>
                    </div>
                    @if (language != 'ja') {
                      <mat-checkbox class="col-md-6" formControlName="show_jp">
                        Show JP characters (untranslated)
                      </mat-checkbox>
                    }
                </div>
            }
            @if (openTab == 1) {
                <div class="row" style="margin-top:0.8rem;">
                    <mat-form-field class="col-md-8" appearance="outline">
                        <mat-label>Filter...</mat-label>
                        <input style="height: 100%;" matInput formControlName="filtertext">
                        <mat-icon matSuffix fontSet="atelier atelier-sm" fontIcon="atelier-ryza2-book">&nbsp;</mat-icon>
                    </mat-form-field>
                    <mat-form-field class="col-md-4" appearance="outline">
                        <mat-label>Sort by...</mat-label>
                        <mat-select matNativeControl formControlName="stats">
                        @for (stat of a25service.stats | keyvalue; track stat) {
                            <mat-option [value]="stat.key">
                                {{stat.value[language]}}
                            </mat-option>
                        }
                        </mat-select>
                    </mat-form-field>
                </div>
                @if (language != 'ja') {
                    <div class="row">
                        <mat-checkbox formControlName="show_jp" style="padding-bottom:1rem;">
                            Show Japanese Memoria (untranslated)
                        </mat-checkbox>
                    </div>
                }
            }
        </form>
    </ng-template>
    <button (click)="save();" mat-fab extended color="primary">
        <mat-icon fontSet="fa-solid" fontIcon="fa-link"></mat-icon> Share
    </button>

    @defer {
    @if (data) {
    <mat-tab-group (selectedTabChange)="changeTab($event)">
        <mat-tab label="Characters">
            <ng-container *ngTemplateOutlet="forms"></ng-container>
            <div class="char-grid">
                @for (chara of filteredCharas | async; track chara) {
                    <div [style]="this.collection.characters[chara.id] ? 'text-align:center;cursor: pointer;' : 'text-align:center;filter:grayscale(.8);cursor: pointer;'" (click)="changeCharacter(chara.id, chara.rarity)">
                    <div style="aspect-ratio:1;position:relative;">
                        <img loading="lazy" width="100%"
                            src="{{imgURL}}characters/face/{{chara.slug}}.webp"
                            alt="{{chara.name + ' ' + chara.title}}"
                            style="position:absolute;z-index:10;max-height:83%;max-width:83%;-webkit-clip-path: polygon(0 0, 100% 0%, 100% 50%, 50% 100%, 0 50%);clip-path: polygon(0 0, 100% 0%, 100% 50%, 50% 100%, 0 50%);left:50%;top:50%;transform:translate(-50%, -50%);">
                            <div style="display:flex;width:100%;position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);">
                            <svg viewBox="0 0 125 250" style="max-width:100%;">
                                <path [attr.fill]="a25service.colors[chara.color1]" d="M128.315904 232.287744H122.368L24.448 134.368256V122.399744L122.368 24.479744H128.34304L128.34304 6.144H121.31328L6.11328 121.344V135.424L121.31328 250.624H128.3072zM128.335872 227.199488H124.000256L29.536256 132.735488V124.031488L124.000256 29.567488H128.326656z" />
                            </svg>
                            <svg viewBox="0 0 125 250" style="max-width:100%;transform:scale(-1,1)">
                                <path [attr.fill]="a25service.colors[chara.color2]" d="M128.315904 232.287744H122.368L24.448 134.368256V122.399744L122.368 24.479744H128.34304L128.34304 6.144H121.31328L6.11328 121.344V135.424L121.31328 250.624H128.3072zM128.335872 227.199488H124.000256L29.536256 132.735488V124.031488L124.000256 29.567488H128.326656z" />
                            </svg>
                            </div>
                        <img
                        style="aspect-ratio:48/45;width:25%;filter:drop-shadow(5px 5px 5px black);position:absolute;bottom:0;left:3%;"
                        src="{{imgURL}}characters/{{chara.role}}.webp"
                        alt="{{chara.role}}"/>
                        <i class="atelier atelier-np atelier-resleri-{{chara.elem}} a25-char-font" style="background-color:{{a25service.elements[chara.elem]}};"></i>
                    </div>
                    <div class="a25-star-font fa-solid" [innerHTML]="fetchStars(chara.id, chara.rarity)"></div>
                    </div>
                }
                </div>
        </mat-tab>
        <mat-tab label="Memoria">
            <ng-container *ngTemplateOutlet="forms"></ng-container>
            @for (memoria of filteredMemoria | async; track memoria) {
                <div style="position: relative;width:min(max(150px,25%),256px);aspect-ratio:256/410;display: inline-block;">
                    <img src="{{imgURL}}memoria/{{memoria.slug}}.webp"
                        (click)="changeMemoria(memoria.id)"
                        [style]="collection.memoria[memoria.id] ? '' : 'filter:grayscale(1)'">
                        @if (collection.memoria[memoria.id] !== undefined) {
                            <div style="position:absolute;bottom:10%;left:50%;transform:translate(-50%,0);font-size:2rem;text-align:center;width:100%;color:white;background:linear-gradient(270deg, rgba(0,0,0,0.5) 0%, rgb(0, 0, 0) 50%, rgba(0,0,0,0.5) 100%);">{{collection.memoria[memoria.id]}}</div>
                        }
                </div>
            }
        </mat-tab>
        <mat-tab label="Emblems">
            <h2>Permanent</h2>
            @for (emblem of data.emblems; track emblem) {
                @if (emblem.kind === 1) {
                    @if (collection.emblems[emblem.eid]) {
                        <img src="{{imgURL}}emblems/emblem-{{emblem.eid}}-{{collection.emblems[emblem.eid]}}.webp" (click)="changeEmblem(emblem.eid)" class="a25-emblem" loading="lazy">
                    }
                    @else {
                        <img src="{{imgURL}}emblems/emblem-{{emblem.eid}}-1.webp" (click)="changeEmblem(emblem.eid)" style="filter: grayscale(.8) drop-shadow(10px 10px 3px darkgray);" class="a25-emblem" loading="lazy">
                    }
                }
            }
            <h2>Limited</h2>
            @for (emblem of data.emblems; track emblem) {
                @if (emblem.kind === 2) {
                    @if (collection.emblems[emblem.eid]) {
                        <img src="{{imgURL}}emblems/emblem-{{emblem.eid}}-{{collection.emblems[emblem.eid]}}.webp" (click)="changeEmblem(emblem.eid)" class="a25-emblem" loading="lazy">
                    }
                    @else {
                        <img src="{{imgURL}}emblems/emblem-{{emblem.eid}}-1.webp" (click)="changeEmblem(emblem.eid)" style="filter: grayscale(.8) drop-shadow(10px 10px 3px darkgray);" class="a25-emblem" loading="lazy">
                    }
                }
            }
        </mat-tab>
    </mat-tab-group>
    }
    }
}